name: Auto Bump Version, Tag, and Push

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  bump-and-tag:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump middle version and reset patch
        id: version
        shell: bash
        run: |
          set -euo pipefail

          CURRENT_VERSION=$(grep -oPm1 '(?<=<version>)[0-9]+\.[0-9]+\.[0-9]+(?=</version>)' install.xml)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          NEXT_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEXT_MINOR}.0"

          while git rev-parse -q --verify "refs/tags/v${NEW_VERSION}" >/dev/null; do
            NEXT_MINOR=$((NEXT_MINOR + 1))
            NEW_VERSION="${MAJOR}.${NEXT_MINOR}.0"
          done

          sed -Ei "s#(<version>)[0-9]+\.[0-9]+\.[0-9]+(</version>)#\1${NEW_VERSION}\2#" install.xml
          sed -Ei "s#(\\\$data\\['current_version'\\] = \")[0-9]+\.[0-9]+\.[0-9]+(\";)#\1${NEW_VERSION}\2#" upload/admin/controller/extension/module/websky_viewed.php

          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit and tag
        run: |
          set -euo pipefail

          git add install.xml upload/admin/controller/extension/module/websky_viewed.php

          if git diff --cached --quiet; then
            echo "No version changes detected."
            exit 0
          fi

          git commit -m "release: v${{ steps.version.outputs.new_version }}"
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "v${{ steps.version.outputs.new_version }}"

      - name: Push commit and tag
        run: |
          git push origin master
          git push origin "v${{ steps.version.outputs.new_version }}"
