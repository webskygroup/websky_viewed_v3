name: Auto Bump Version, Tag, and Push

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  bump-and-tag:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Detect bump type from commit messages
        id: bump
        shell: bash
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"

          if [[ "$BEFORE_SHA" =~ ^0+$ ]]; then
            MESSAGES=$(git log --pretty=%s -n 1 "$AFTER_SHA")
          else
            MESSAGES=$(git log --pretty=%s "$BEFORE_SHA..$AFTER_SHA")
          fi

          BUMP_TYPE="patch"

          if echo "$MESSAGES" | grep -Eiq '(\[major\]|BREAKING CHANGE|^[a-zA-Z0-9_-]+(\(.+\))?!:)'; then
            BUMP_TYPE="major"
          elif echo "$MESSAGES" | grep -Eiq '(^feat(\(.+\))?:|\[minor\])'; then
            BUMP_TYPE="minor"
          elif echo "$MESSAGES" | grep -Eiq '(^fix(\(.+\))?:|\[patch\])'; then
            BUMP_TYPE="patch"
          fi

          echo "bump_type=${BUMP_TYPE}" >> "$GITHUB_OUTPUT"
          echo "Detected bump type: ${BUMP_TYPE}"

      - name: Bump version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          BUMP_TYPE="${{ steps.bump.outputs.bump_type }}"
          CURRENT_VERSION=$(grep -oPm1 '(?<=<version>)[0-9]+\.[0-9]+\.[0-9]+(?=</version>)' install.xml)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case "$BUMP_TYPE" in
            major)
              NEXT_MAJOR=$((MAJOR + 1))
              NEW_VERSION="${NEXT_MAJOR}.0.0"
              ;;
            minor)
              NEXT_MINOR=$((MINOR + 1))
              NEW_VERSION="${MAJOR}.${NEXT_MINOR}.0"
              ;;
            *)
              NEXT_PATCH=$((PATCH + 1))
              NEW_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
              ;;
          esac

          while git rev-parse -q --verify "refs/tags/v${NEW_VERSION}" >/dev/null; do
            case "$BUMP_TYPE" in
              major)
                NEXT_MAJOR=$((NEXT_MAJOR + 1))
                NEW_VERSION="${NEXT_MAJOR}.0.0"
                ;;
              minor)
                NEXT_MINOR=$((NEXT_MINOR + 1))
                NEW_VERSION="${MAJOR}.${NEXT_MINOR}.0"
                ;;
              *)
                NEXT_PATCH=$((NEXT_PATCH + 1))
                NEW_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
                ;;
            esac
          done

          sed -Ei "s#(<version>)[0-9]+\.[0-9]+\.[0-9]+(</version>)#\1${NEW_VERSION}\2#" install.xml
          sed -Ei "s#(\\\$data\\['current_version'\\] = \")[0-9]+\.[0-9]+\.[0-9]+(\";)#\1${NEW_VERSION}\2#" upload/admin/controller/extension/module/websky_viewed.php

          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit and tag
        run: |
          set -euo pipefail

          git add install.xml upload/admin/controller/extension/module/websky_viewed.php

          if git diff --cached --quiet; then
            echo "No version changes detected."
            exit 0
          fi

          git commit -m "release: v${{ steps.version.outputs.new_version }}"
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "v${{ steps.version.outputs.new_version }}"

      - name: Push commit and tag
        run: |
          git push origin master
          git push origin "v${{ steps.version.outputs.new_version }}"
